 

services:
  # WA-Gateway Service - Go + whatsmeow (replaces wa-clientes and wa-proveedores)
  wa-gateway:
    build:
      context: ./go-services/wa-gateway
      dockerfile: Dockerfile
    container_name: tinkubot-wa-gateway
    ports:
      - "${WA_GATEWAY_PORT:-7000}:${WA_GATEWAY_PORT:-7000}"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - GATEWAY_PORT=${WA_GATEWAY_PORT:-7000}
      - RATE_LIMIT_MAX_PER_HOUR=${WA_RATE_LIMIT_MAX_PER_HOUR:-20}
      - RATE_LIMIT_MAX_PER_24H=${WA_RATE_LIMIT_MAX_PER24H:-100}
      - LOG_LEVEL=${WA_GATEWAY_LOG_LEVEL:-info}
    networks:
      - tinkubot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/wa-gateway", "--healthcheck"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # Frontend Service - Interfaz web para el usuario
  frontend:
    build:
      context: ./nodejs-services/frontend
      dockerfile: Dockerfile
    container_name: tinkubot-frontend
    ports:
      - "${FRONTEND_SERVICE_PORT:-5000}:${FRONTEND_SERVICE_PORT:-5000}"
    environment:
      - FRONTEND_SERVICE_PORT=${FRONTEND_SERVICE_PORT}
      - WHATSAPP_CLIENTES_URL=${WHATSAPP_CLIENTES_URL}
      - WHATSAPP_PROVEEDORES_URL=${WHATSAPP_PROVEEDORES_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_PROVIDERS_TABLE=${SUPABASE_PROVIDERS_TABLE:-providers}
      - PROVIDERS_PENDING_LIMIT=${PROVIDERS_PENDING_LIMIT:-100}
      - ADMIN_USER=${ADMIN_USER}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - NODE_ENV=production
    networks:
      - tinkubot-network
    restart: unless-stopped

  redis:
    build: ./infrastructure-services/message-queue
    container_name: tinkubot-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - tinkubot-network
    restart: unless-stopped

  av-proveedores:
    build:
      context: ./python-services/av-proveedores
      dockerfile: Dockerfile
    container_name: tinkubot-av-proveedores
    environment:
      - AV_PROVEEDORES_PUERTO=${AV_PROVEEDORES_PUERTO:-8005}
    ports:
      - "${AV_PROVEEDORES_PUERTO:-8005}:${AV_PROVEEDORES_PUERTO:-8005}"
    networks:
      - tinkubot-network
    restart: unless-stopped

  # AI Service Clientes - Procesamiento con sesiones integradas
  ai-clientes:
    build:
      context: ./python-services
      dockerfile: ai-clientes/Dockerfile
    container_name: tinkubot-ai-clientes
    ports:
      - "${CLIENTES_SERVER_PORT:-8001}:${CLIENTES_SERVER_PORT:-8001}"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_URL=${REDIS_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - AVAILABILITY_TIMEOUT_SECONDS=${AVAILABILITY_TIMEOUT_SECONDS:-60}
      - AVAILABILITY_ACCEPT_GRACE_SECONDS=${AVAILABILITY_ACCEPT_GRACE_SECONDS:-60}
      - CLIENTES_SERVER_PORT=${CLIENTES_SERVER_PORT}
      - AI_SERVICE_CLIENTES_PORT=${AI_SERVICE_CLIENTES_PORT}
      - SERVER_HOST=${SERVER_HOST}
      - NODE_ENV=production
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tinkubot-network
    restart: unless-stopped

  # AI Service Proveedores - Procesamiento con sesiones integradas
  ai-proveedores:
    build:
      context: ./python-services
      dockerfile: ai-proveedores/Dockerfile
    container_name: tinkubot-ai-proveedores
    ports:
      - "${PROVEEDORES_SERVER_PORT:-8002}:${PROVEEDORES_SERVER_PORT:-8002}"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_URL=${REDIS_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_PROVIDERS_BUCKET=${SUPABASE_PROVIDERS_BUCKET:-tinkubot-providers}
      - PROVEEDORES_SERVER_PORT=${PROVEEDORES_SERVER_PORT}
      - AI_SERVICE_PROVEEDORES_PORT=${AI_SERVICE_PROVEEDORES_PORT}
      - SERVER_HOST=${SERVER_HOST}
      - NODE_ENV=production
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tinkubot-network
    restart: unless-stopped

  # AI Search Service - Servicio de b√∫squeda optimizado con IA
  ai-search:
    build:
      context: ./python-services
      dockerfile: ai-search/Dockerfile
    container_name: tinkubot-ai-search
    ports:
      - "${AI_SEARCH_PORT:-8000}:${AI_SEARCH_PORT:-8000}"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AI_SEARCH_PORT=${AI_SEARCH_PORT}
      - NODE_ENV=production
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tinkubot-network
    restart: unless-stopped


networks:
  tinkubot-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
