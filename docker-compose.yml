 

services:
  # Frontend Service - Interfaz web para el usuario
  frontend:
    build:
      context: ./nodejs-services/frontend
      dockerfile: Dockerfile
    container_name: tinkubot-frontend
    ports:
      - "${FRONTEND_SERVICE_PORT:-5000}:${FRONTEND_SERVICE_PORT:-5000}"
    environment:
      - FRONTEND_SERVICE_PORT=${FRONTEND_SERVICE_PORT}
      - WHATSAPP_CLIENTES_URL=${WHATSAPP_CLIENTES_URL}
      - WHATSAPP_PROVEEDORES_URL=${WHATSAPP_PROVEEDORES_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_BACKEND_API_KEY=${SUPABASE_BACKEND_API_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_PROVIDERS_TABLE=${SUPABASE_PROVIDERS_TABLE:-providers}
      - PROVIDERS_PENDING_LIMIT=${PROVIDERS_PENDING_LIMIT:-100}
      - ADMIN_USER=${ADMIN_USER}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - NODE_ENV=production
    networks:
      - tinkubot-network
    restart: unless-stopped

  mosquitto:
    build: ./infrastructure-services/messaging-broker
    container_name: tinkubot-mosquitto
    ports:
      - "1883:1883"
    networks:
      - tinkubot-network
    restart: unless-stopped

  redis:
    build: ./infrastructure-services/message-queue
    container_name: tinkubot-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - tinkubot-network
    restart: unless-stopped

  av-proveedores:
    build:
      context: ./python-services/av-proveedores
      dockerfile: Dockerfile
    container_name: tinkubot-av-proveedores
    depends_on:
      - mosquitto
    environment:
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - MQTT_TEMA_PETICION=av-proveedores/solicitud
      - MQTT_TEMA_RESPUESTA=av-proveedores/respuesta
      - AV_PROVEEDORES_PUERTO=${AV_PROVEEDORES_PUERTO:-8005}
      - MQTT_USUARIO
      - MQTT_PASSWORD
    ports:
      - "${AV_PROVEEDORES_PUERTO:-8005}:${AV_PROVEEDORES_PUERTO:-8005}"
    networks:
      - tinkubot-network
    restart: unless-stopped

  # WhatsApp Service - Bot Clientes (+593 99 882 3053)
  wa-clientes:
    build:
      context: ./nodejs-services/wa-clientes
      dockerfile: Dockerfile
    container_name: tinkubot-wa-clientes
    ports:
      - "${CLIENTES_WHATSAPP_PORT:-5001}:${CLIENTES_WHATSAPP_PORT:-5001}"
    environment:
      # ACTUALIZADO: Usa el AI Service Clientes específico para esta instancia
      - AI_SERVICE_CLIENTES_URL=${AI_SERVICE_CLIENTES_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_BACKEND_API_KEY=${SUPABASE_BACKEND_API_KEY}
      - SUPABASE_BUCKET_NAME=${SUPABASE_BUCKET_NAME}
      - CLIENTES_WHATSAPP_PORT=${CLIENTES_WHATSAPP_PORT}
      - WHATSAPP_CLIENTES_PORT=${WHATSAPP_CLIENTES_PORT}
      - CLIENTES_INSTANCE_ID=${CLIENTES_INSTANCE_ID}
      - CLIENTES_INSTANCE_NAME=${CLIENTES_INSTANCE_NAME}
      - NODE_ENV=production
    networks:
      - tinkubot-network
    restart: unless-stopped

  # WhatsApp Service - Bot Proveedores (segundo número)
  wa-proveedores:
    build:
      context: ./nodejs-services/wa-proveedores
      dockerfile: Dockerfile
    container_name: tinkubot-wa-proveedores
    ports:
      - "${PROVEEDORES_WHATSAPP_PORT:-5002}:${PROVEEDORES_WHATSAPP_PORT:-5002}"
    environment:
      # ACTUALIZADO: Usa el AI Service Proveedores específico para esta instancia
      - PROVEEDORES_AI_SERVICE_URL=${PROVEEDORES_AI_SERVICE_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_BACKEND_API_KEY=${SUPABASE_BACKEND_API_KEY}
      - SUPABASE_BUCKET_NAME=${SUPABASE_BUCKET_NAME}
      - PROVEEDORES_WHATSAPP_PORT=${PROVEEDORES_WHATSAPP_PORT}
      - WHATSAPP_PROVEEDORES_PORT=${WHATSAPP_PROVEEDORES_PORT}
      - PROVEEDORES_INSTANCE_ID=${PROVEEDORES_INSTANCE_ID}
      - PROVEEDORES_INSTANCE_NAME=${PROVEEDORES_INSTANCE_NAME}
      - NODE_ENV=production
    networks:
      - tinkubot-network
    restart: unless-stopped

  # AI Service Clientes - Procesamiento con sesiones integradas
  ai-clientes:
    build:
      context: ./python-services
      dockerfile: ai-clientes/Dockerfile
    container_name: tinkubot-ai-clientes
    ports:
      - "${CLIENTES_SERVER_PORT:-8001}:${CLIENTES_SERVER_PORT:-8001}"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_URL=${REDIS_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_BACKEND_API_KEY=${SUPABASE_BACKEND_API_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - AVAILABILITY_TIMEOUT_SECONDS=${AVAILABILITY_TIMEOUT_SECONDS:-60}
      - AVAILABILITY_ACCEPT_GRACE_SECONDS=${AVAILABILITY_ACCEPT_GRACE_SECONDS:-60}
      - CLIENTES_SERVER_PORT=${CLIENTES_SERVER_PORT}
      - AI_SERVICE_CLIENTES_PORT=${AI_SERVICE_CLIENTES_PORT}
      - SERVER_HOST=${SERVER_HOST}
      - NODE_ENV=production
      # MQTT Configuration
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - MQTT_USUARIO=${MQTT_USUARIO:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      - MQTT_PUBLISH_TIMEOUT=5
      - MQTT_QOS=1
      - MQTT_TEMA_SOLICITUD=av-proveedores/solicitud
      - MQTT_TEMA_RESPUESTA=av-proveedores/respuesta
      - AVAILABILITY_TIMEOUT_SECONDS=45
      - AVAILABILITY_ACCEPT_GRACE_SECONDS=2.0
      - LOG_SAMPLING_RATE=10
      - AVAILABILITY_STATE_TTL_SECONDS=300
      - AVAILABILITY_POLL_INTERVAL_SECONDS=1.5
    depends_on:
      mosquitto:
        condition: service_started
      redis:
        condition: service_healthy
    networks:
      - tinkubot-network
    restart: unless-stopped

  # AI Service Proveedores - Procesamiento con sesiones integradas
  ai-proveedores:
    build:
      context: ./python-services
      dockerfile: ai-proveedores/Dockerfile
    container_name: tinkubot-ai-proveedores
    ports:
      - "${PROVEEDORES_SERVER_PORT:-8002}:${PROVEEDORES_SERVER_PORT:-8002}"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_URL=${REDIS_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_BACKEND_API_KEY=${SUPABASE_BACKEND_API_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_PROVIDERS_BUCKET=${SUPABASE_PROVIDERS_BUCKET:-tinkubot-providers}
      - PROVEEDORES_SERVER_PORT=${PROVEEDORES_SERVER_PORT}
      - AI_SERVICE_PROVEEDORES_PORT=${AI_SERVICE_PROVEEDORES_PORT}
      - SERVER_HOST=${SERVER_HOST}
      - NODE_ENV=production
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tinkubot-network
    restart: unless-stopped

  # AI Search Service - Servicio de búsqueda optimizado con IA
  ai-search:
    build:
      context: ./python-services
      dockerfile: ai-search/Dockerfile
    container_name: tinkubot-ai-search
    ports:
      - "${AI_SEARCH_PORT:-8000}:${AI_SEARCH_PORT:-8000}"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AI_SEARCH_PORT=${AI_SEARCH_PORT}
      - NODE_ENV=production
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tinkubot-network
    restart: unless-stopped


networks:
  tinkubot-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
