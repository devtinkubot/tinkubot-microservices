 

services:
  # WA-Gateway Service - Go + whatsmeow + SQLite
  wa-gateway:
    build:
      context: ./go-services/wa-gateway
      dockerfile: Dockerfile
    container_name: tinkubot-wa-gateway
    ports:
      - "${WA_GATEWAY_PORT:-7000}:${WA_GATEWAY_PORT:-7000}"
    dns:
      - 127.0.0.11
      - 8.8.8.8
    dns_search: .
    environment:
      - GATEWAY_PORT=${WA_GATEWAY_PORT:-7000}
      - DATABASE_PATH=file:./data/wa-gateway.db?_foreign_keys=on
      - RATE_LIMIT_MAX_PER_HOUR=${WA_RATE_LIMIT_MAX_PER_HOUR:-20}
      - RATE_LIMIT_MAX_PER_24H=${WA_RATE_LIMIT_MAX_PER24H:-100}
      # Webhook Configuration (Dynamic Routing)
      - AI_CLIENTES_URL=${AI_CLIENTES_URL:-http://ai-clientes:8001}
      - AI_PROVEEDORES_URL=${AI_PROVEEDORES_URL:-http://ai-proveedores:8002}
      - WEBHOOK_ENDPOINT=${WEBHOOK_ENDPOINT:-/handle-whatsapp-message}
      - WEBHOOK_TIMEOUT_MS=${WEBHOOK_TIMEOUT_MS:-10000}
      - WEBHOOK_RETRY_ATTEMPTS=${WEBHOOK_RETRY_ATTEMPTS:-3}
      - WA_CLIENTES_DEVICE_JID=${WA_CLIENTES_DEVICE_JID}
      - WA_PROVEEDORES_DEVICE_JID=${WA_PROVEEDORES_DEVICE_JID}
    volumes:
      - ./wa-data:/app/data
    networks:
      - tinkubot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/app/wa-gateway", "--healthcheck"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # Frontend Service - Interfaz web para el usuario
  frontend:
    build:
      context: ./nodejs-services/frontend
      dockerfile: Dockerfile
    container_name: tinkubot-frontend
    ports:
      - "${FRONTEND_SERVICE_PORT:-5000}:${FRONTEND_SERVICE_PORT:-5000}"
    environment:
      - FRONTEND_SERVICE_PORT=${FRONTEND_SERVICE_PORT}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_PROVIDERS_TABLE=${SUPABASE_PROVIDERS_TABLE:-providers}
      - PROVIDERS_PENDING_LIMIT=${PROVIDERS_PENDING_LIMIT:-100}
      - ADMIN_USER=${ADMIN_USER}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - NODE_ENV=production
    networks:
      - tinkubot-network
    restart: unless-stopped

  redis:
    build: ./infrastructure-services/message-queue
    container_name: tinkubot-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - tinkubot-network
    restart: unless-stopped

  # AI Service Clientes - Procesamiento con sesiones integradas
  ai-clientes:
    build:
      context: ./python-services
      dockerfile: ai-clientes/Dockerfile
    container_name: tinkubot-ai-clientes
    ports:
      - "${CLIENTES_SERVER_PORT:-8001}:${CLIENTES_SERVER_PORT:-8001}"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_URL=${REDIS_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - CLIENTES_SERVER_PORT=${CLIENTES_SERVER_PORT}
      - AI_SERVICE_CLIENTES_PORT=${AI_SERVICE_CLIENTES_PORT}
      - SERVER_HOST=${SERVER_HOST}
      - NODE_ENV=production
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tinkubot-network
    restart: unless-stopped

  # AI Service Proveedores - Procesamiento con sesiones integradas
  ai-proveedores:
    build:
      context: ./python-services
      dockerfile: ai-proveedores/Dockerfile
    container_name: tinkubot-ai-proveedores
    ports:
      - "${PROVEEDORES_SERVER_PORT:-8002}:${PROVEEDORES_SERVER_PORT:-8002}"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_URL=${REDIS_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_PROVIDERS_BUCKET=${SUPABASE_PROVIDERS_BUCKET:-tinkubot-providers}
      - PROVEEDORES_SERVER_PORT=${PROVEEDORES_SERVER_PORT}
      - AI_SERVICE_PROVEEDORES_PORT=${AI_SERVICE_PROVEEDORES_PORT}
      - SERVER_HOST=${SERVER_HOST}
      - NODE_ENV=production
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tinkubot-network
    restart: unless-stopped

  # AI Search Service - Servicio de b√∫squeda optimizado con IA
  ai-search:
    build:
      context: ./python-services
      dockerfile: ai-search/Dockerfile
    container_name: tinkubot-ai-search
    ports:
      - "${AI_SEARCH_PORT:-8000}:${AI_SEARCH_PORT:-8000}"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AI_SEARCH_PORT=${AI_SEARCH_PORT}
      - NODE_ENV=production
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - tinkubot-network
    restart: unless-stopped


networks:
  tinkubot-network:
    driver: bridge
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: 172.18.0.0/16
          gateway: 172.18.0.1
        - subnet: 2001:db8:dead:beef::/64
          gateway: 2001:db8:dead:beef::1

volumes:
  redis-data:
    driver: local
  wa-data:
    driver: local
